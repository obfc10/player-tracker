"use strict";(()=>{var e={};e.id=9187,e.ids=[9187],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84760:(e,n,t)=>{t.r(n),t.d(n,{headerHooks:()=>m,originalPathname:()=>O,patchFetch:()=>f,requestAsyncStorage:()=>A,routeModule:()=>w,serverHooks:()=>h,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>g});var a={};t.r(a),t.d(a,{GET:()=>s,dynamic:()=>d,runtime:()=>c});var l=t(6170),r=t(8533),i=t(54387),o=t(40064);!function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}();let c="nodejs",d="force-dynamic";async function s(e){try{let{searchParams:n}=new URL(e.url),t=parseInt(n.get("limit")||"50"),a=parseInt(n.get("page")||"1"),l=n.get("alliance")||"all",r=n.get("timeRange")||"30",i=n.get("sortBy")||"detectedAt",c="asc"===n.get("order")?"asc":"desc",d=new Date,s=new Date;s.setDate(s.getDate()-parseInt(r));let w={detectedAt:{gte:s,lte:d}};"all"!==l&&(w.OR=[{oldAlliance:l},{newAlliance:l}]);let A=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).allianceChange.count({where:w}),p=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).allianceChange.findMany({where:w,include:{player:{include:{snapshots:{include:{snapshot:!0},orderBy:{snapshot:{timestamp:"desc"}},take:1}}}},orderBy:{[i]:c},skip:(a-1)*t,take:t}),h=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).allianceChange.findMany({where:{detectedAt:{gte:s,lte:d}},select:{oldAlliance:!0,newAlliance:!0},distinct:["oldAlliance","newAlliance"]}),m=new Set;h.forEach(e=>{e.oldAlliance&&m.add(e.oldAlliance),e.newAlliance&&m.add(e.newAlliance)});let g=await u(s,d),O=p.map(e=>{var n,t;let a=e.player.snapshots[0];return{id:e.id,playerId:e.playerId,playerName:e.player.currentName,oldAlliance:e.oldAlliance,oldAllianceId:e.oldAllianceId,newAlliance:e.newAlliance,newAllianceId:e.newAllianceId,detectedAt:e.detectedAt,moveType:(n=e.oldAlliance,t=e.newAlliance,!n&&t?"joined":n&&!t?"left":n&&t?"transferred":"unknown"),currentPower:a?parseInt(a.currentPower):0,cityLevel:a?a.cityLevel:0,division:a?a.division:0}}),f=Math.ceil(A/t);return o.Z.json({moves:O,summary:g,pagination:{currentPage:a,totalPages:f,totalMoves:A,limit:t},filters:{alliances:Array.from(m).filter(Boolean).sort(),timeRange:parseInt(r),alliance:l,sortBy:i,order:c}})}catch(e){return console.error("Error fetching alliance moves:",e),o.Z.json({error:"Failed to fetch alliance moves data"},{status:500})}}async function u(e,n){let t=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).allianceChange.count({where:{detectedAt:{gte:e,lte:n}}}),a=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).allianceChange.count({where:{detectedAt:{gte:e,lte:n},oldAlliance:null,newAlliance:{not:null}}}),l=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).allianceChange.count({where:{detectedAt:{gte:e,lte:n},oldAlliance:{not:null},newAlliance:null}});return{totalMoves:t,joins:a,leaves:l,transfers:await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).allianceChange.count({where:{detectedAt:{gte:e,lte:n},oldAlliance:{not:null},newAlliance:{not:null}}}),netMovement:a-l,mostActiveAlliances:(await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).allianceChange.groupBy({by:["newAlliance"],where:{detectedAt:{gte:e,lte:n},newAlliance:{not:null}},_count:{newAlliance:!0},orderBy:{_count:{newAlliance:"desc"}},take:5})).map(e=>({alliance:e.newAlliance,joinCount:e._count.newAlliance})),timeRange:{start:e,end:n,days:Math.ceil((n.getTime()-e.getTime())/864e5)}}}let w=new l.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/alliance-moves/route",pathname:"/api/alliance-moves",filename:"route",bundlePath:"app/api/alliance-moves/route"},resolvedPagePath:"/Users/ciaranobrien/player-tracker/src/app/api/alliance-moves/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:A,staticGenerationAsyncStorage:p,serverHooks:h,headerHooks:m,staticGenerationBailout:g}=w,O="/api/alliance-moves/route";function f(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:p})}}};var n=require("../../../webpack-runtime.js");n.C(e);var t=e=>n(n.s=e),a=n.X(0,[3499,7386],()=>t(84760));module.exports=a})();