"use strict";(()=>{var e={};e.id=5941,e.ids=[5941],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},10946:(e,a,t)=>{t.r(a),t.d(a,{headerHooks:()=>w,originalPathname:()=>N,patchFetch:()=>f,requestAsyncStorage:()=>h,routeModule:()=>u,serverHooks:()=>g,staticGenerationAsyncStorage:()=>p,staticGenerationBailout:()=>y});var n={};t.r(n),t.d(n,{GET:()=>c,dynamic:()=>s,runtime:()=>d});var r=t(6170),o=t(8533),l=t(54387),i=t(40064);!function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}();let d="nodejs",s="force-dynamic";async function c(e){try{let{searchParams:a}=new URL(e.url),t=parseInt(a.get("limit")||"50"),n=parseInt(a.get("page")||"1"),r=a.get("alliance")||"all",o=a.get("timeRange")||"30",l=a.get("sortBy")||"detectedAt",d="asc"===a.get("order")?"asc":"desc",s=a.get("search")||"",c=new Date,u=new Date;u.setDate(u.getDate()-parseInt(o));let h={detectedAt:{gte:u,lte:c}};s&&(h.OR=[{oldName:{contains:s,mode:"insensitive"}},{newName:{contains:s,mode:"insensitive"}},{player:{lordId:{contains:s,mode:"insensitive"}}}]);let p=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).nameChange.count({where:h}),g=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).nameChange.findMany({where:h,include:{player:{include:{snapshots:{include:{snapshot:!0},orderBy:{snapshot:{timestamp:"desc"}},take:1}}}},orderBy:{[l]:d},skip:(n-1)*t,take:t}),w=g;"all"!==r&&(w=g.filter(e=>{let a=e.player.snapshots[0];return a&&a.allianceTag===r}));let y=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:{snapshot:{timestamp:{gte:u,lte:c}},allianceTag:{not:null}},select:{allianceTag:!0},distinct:["allianceTag"],orderBy:{allianceTag:"asc"}}),N=await m(u,c),f=w.map(e=>{let a=e.player.snapshots[0];return{id:e.id,playerId:e.playerId,playerCurrentName:e.player.currentName||e.newName,oldName:e.oldName,newName:e.newName,detectedAt:e.detectedAt,currentPower:a?parseInt(a.currentPower):0,cityLevel:a?a.cityLevel:0,division:a?a.division:0,allianceTag:a?a.allianceTag:null,nameLength:{old:e.oldName.length,new:e.newName.length},similarity:function(e,a){let t=e.toLowerCase(),n=a.toLowerCase(),r=0,o=Math.max(t.length,n.length);for(let e=0;e<Math.min(t.length,n.length);e++)t[e]===n[e]&&r++;return Math.round(r/o*100)}(e.oldName,e.newName)}}),O=Math.ceil(p/t);return i.Z.json({changes:f,summary:N,pagination:{currentPage:n,totalPages:O,totalChanges:p,limit:t},filters:{alliances:y.map(e=>e.allianceTag).filter(Boolean),timeRange:parseInt(o),alliance:r,sortBy:l,order:d,search:s}})}catch(e){return console.error("Error fetching name changes:",e),i.Z.json({error:"Failed to fetch name changes data"},{status:500})}}async function m(e,a){var t;let n,r,o,l,i,d;let s=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).nameChange.count({where:{detectedAt:{gte:e,lte:a}}}),c=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).nameChange.groupBy({by:["playerId"],where:{detectedAt:{gte:e,lte:a}},_count:{playerId:!0},orderBy:{_count:{playerId:"desc"}},take:5}),m=await Promise.all(c.map(async e=>{let a=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).player.findUnique({where:{lordId:e.playerId},include:{snapshots:{include:{snapshot:!0},orderBy:{snapshot:{timestamp:"desc"}},take:1}}});return{playerId:e.playerId,playerName:a?.currentName||"Unknown",changeCount:e._count.playerId,currentPower:a?.snapshots[0]?parseInt(a.snapshots[0].currentPower):0,allianceTag:a?.snapshots[0]?.allianceTag||null}})),u=(t=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).nameChange.findMany({where:{detectedAt:{gte:e,lte:a}},select:{oldName:!0,newName:!0}}),n=0,r=0,o=0,l=0,i=0,d=0,t.forEach(e=>{let a=/\d/.test(e.oldName),t=/\d/.test(e.newName),s=/[^a-zA-Z0-9]/.test(e.oldName),c=/[^a-zA-Z0-9]/.test(e.newName);!a&&t&&n++,a&&!t&&r++,!s&&c&&o++,s&&!c&&l++,e.newName.length>e.oldName.length&&i++,e.newName.length<e.oldName.length&&d++}),{addedNumbers:n,removedNumbers:r,addedSpecialChars:o,removedSpecialChars:l,lengthIncreases:i,lengthDecreases:d,totalAnalyzed:t.length});return{totalChanges:s,averageChangesPerDay:Math.round(s/Math.max(1,(a.getTime()-e.getTime())/864e5)),mostActiveChangers:m,patterns:u,timeRange:{start:e,end:a,days:Math.ceil((a.getTime()-e.getTime())/864e5)}}}let u=new r.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/name-changes/route",pathname:"/api/name-changes",filename:"route",bundlePath:"app/api/name-changes/route"},resolvedPagePath:"/Users/ciaranobrien/player-tracker/src/app/api/name-changes/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:h,staticGenerationAsyncStorage:p,serverHooks:g,headerHooks:w,staticGenerationBailout:y}=u,N="/api/name-changes/route";function f(){return(0,l.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:p})}}};var a=require("../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),n=a.X(0,[3499,7386],()=>t(10946));module.exports=n})();