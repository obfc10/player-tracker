"use strict";(()=>{var e={};e.id=1440,e.ids=[1440],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6266:(e,a,t)=>{t.r(a),t.d(a,{headerHooks:()=>g,originalPathname:()=>y,patchFetch:()=>w,requestAsyncStorage:()=>p,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>u,staticGenerationBailout:()=>f});var n={};t.r(n),t.d(n,{GET:()=>d,dynamic:()=>c,runtime:()=>l});var i=t(6170),r=t(8533),s=t(54387),o=t(40064);!function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}();let l="nodejs",c="force-dynamic";async function d(e){try{let a,t;let{searchParams:n}=new URL(e.url),i=n.get("compareType")||"previous",r=n.get("fromDate"),s=n.get("toDate"),l=n.get("metric")||"currentPower",c=parseInt(n.get("limit")||"20"),d=n.get("alliance")||"all",m=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).snapshot.findMany({orderBy:{timestamp:"desc"},take:10});if(m.length<2)return o.Z.json({error:"Not enough snapshots for comparison",gainers:[],losers:[],snapshots:m.map(e=>({id:e.id,timestamp:e.timestamp,kingdom:e.kingdom,filename:e.filename}))});switch(i){case"previous":default:t=m[0],a=m[1];break;case"week":t=m[0];let p=new Date;p.setDate(p.getDate()-7),a=m.find(e=>new Date(e.timestamp)<=p)||m[m.length-1];break;case"custom":if(!r||!s)return o.Z.json({gainers:[],losers:[],smallestIncreases:[],summary:null,availableSnapshots:m.map(e=>({id:e.id,timestamp:e.timestamp,kingdom:e.kingdom,filename:e.filename})),alliances:[],alliance:d});t=m.find(e=>e.id===s)||m[0],a=m.find(e=>e.id===r)||m[1]}let u="all"!==d?{allianceTag:d}:{},[h,g]=await Promise.all([Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:{snapshotId:a.id,...u},include:{player:!0}}),Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:{snapshotId:t.id,...u},include:{player:!0}})]),f=new Map(h.map(e=>[e.playerId,e]));g.map(e=>[e.playerId,e]);let y=[];g.forEach(e=>{let a=f.get(e.playerId);if(!a)return;let t=(e,a)=>{switch(a){case"currentPower":case"power":case"buildingPower":case"heroPower":case"legionPower":case"techPower":case"merits":case"unitsKilled":case"unitsDead":case"unitsHealed":case"gold":case"wood":case"ore":case"mana":case"gems":return parseInt(e[a]||"0");case"cityLevel":case"victories":case"defeats":case"citySieges":case"scouted":case"helpsGiven":case"division":return e[a]||0;case"killDeathRatio":let t=parseInt(e.unitsKilled||"0"),n=parseInt(e.unitsDead||"0");return n>0?t/n:t>0?999:0;case"winRate":let i=e.victories||0,r=e.defeats||0;return i+r>0?i/(i+r)*100:0;default:return 0}},n=t(a,l),i=t(e,l),r=i-n,s=n>0?r/n*100:r>0?100:0;Math.abs(r)>0&&y.push({playerId:e.playerId,name:e.name,currentName:e.player.currentName,allianceTag:e.allianceTag,division:e.division,cityLevel:e.cityLevel,fromValue:n,toValue:i,change:r,percentChange:Math.round(100*s)/100})}),y.sort((e,a)=>Math.abs(a.change)-Math.abs(e.change));let w=y.filter(e=>e.change>0),v=y.filter(e=>e.change<0),b=w.slice(0,c),O=v.slice(0,c),k=w.sort((e,a)=>e.change-a.change).slice(0,c),D=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:{snapshotId:t.id,allianceTag:{not:null}},select:{allianceTag:!0},distinct:["allianceTag"],orderBy:{allianceTag:"asc"}}),M=y.length,T=b.length,E=O.length,I=y.length>0?y.reduce((e,a)=>e+a.change,0)/y.length:0;return o.Z.json({gainers:b,losers:O,smallestIncreases:k,summary:{totalPlayers:M,playersGained:T,playersLost:E,avgChange:Math.round(100*I)/100,metric:l,compareType:i,fromSnapshot:{id:a.id,timestamp:a.timestamp,kingdom:a.kingdom,filename:a.filename},toSnapshot:{id:t.id,timestamp:t.timestamp,kingdom:t.kingdom,filename:t.filename}},availableSnapshots:m.map(e=>({id:e.id,timestamp:e.timestamp,kingdom:e.kingdom,filename:e.filename})),alliances:D.map(e=>e.allianceTag).filter(Boolean),alliance:d})}catch(e){return console.error("Error fetching changes data:",e),o.Z.json({error:"Failed to fetch changes data"},{status:500})}}let m=new i.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/changes/route",pathname:"/api/changes",filename:"route",bundlePath:"app/api/changes/route"},resolvedPagePath:"/Users/ciaranobrien/player-tracker/src/app/api/changes/route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:u,serverHooks:h,headerHooks:g,staticGenerationBailout:f}=m,y="/api/changes/route";function w(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:u})}}};var a=require("../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),n=a.X(0,[3499,7386],()=>t(6266));module.exports=n})();