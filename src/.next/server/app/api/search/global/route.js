"use strict";(()=>{var e={};e.id=2364,e.ids=[2364],e.modules={30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},96294:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>y,originalPathname:()=>b,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>w,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>f});var a={};t.r(a),t.d(a,{GET:()=>d,dynamic:()=>c,runtime:()=>s});var n=t(6170),o=t(8533),l=t(54387),i=t(40064);!function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}();let s="nodejs",c="force-dynamic";async function d(e){try{let{searchParams:r}=new URL(e.url),t=r.get("q")?.trim(),a=Math.min(parseInt(r.get("limit")||"20"),50);if(!t||t.length<2)return i.Z.json({results:[],query:t||"",totalResults:0});let n=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).snapshot.findFirst({orderBy:{timestamp:"desc"}});if(!n)return i.Z.json({results:[],query:t,totalResults:0,error:"No data available"});let o=[];(await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:{snapshotId:n.id,OR:[{name:{contains:t,mode:"insensitive"}},{playerId:{contains:t,mode:"insensitive"}},{player:{currentName:{contains:t,mode:"insensitive"}}}]},include:{player:{include:{nameHistory:{where:{OR:[{oldName:{contains:t,mode:"insensitive"}},{newName:{contains:t,mode:"insensitive"}}]},orderBy:{detectedAt:"desc"},take:1}}}},orderBy:[{currentPower:"desc"},{name:"asc"}],take:a})).forEach(e=>{let r=function(e,r){let t=r.toLowerCase(),a=0;e.name.toLowerCase()===t?a+=100:e.name.toLowerCase().startsWith(t)?a+=80:e.name.toLowerCase().includes(t)&&(a+=60),e.player.currentName.toLowerCase()===t?a+=90:e.player.currentName.toLowerCase().startsWith(t)?a+=70:e.player.currentName.toLowerCase().includes(t)&&(a+=50),e.playerId.toLowerCase()===t?a+=95:e.playerId.toLowerCase().includes(t)&&(a+=40);let n=parseInt(e.currentPower);return n>1e8?a+=20:n>5e7?a+=15:n>1e7?a+=10:n>1e6&&(a+=5),a}(e,t);if(o.push({type:"player",id:e.playerId,title:e.name,subtitle:`${e.allianceTag||"No Alliance"} • ${u(parseInt(e.currentPower))} Power • ID: ${e.playerId}`,power:parseInt(e.currentPower),url:`/dashboard/player/${e.playerId}`,relevance:r}),e.player.nameHistory.length>0){let t=e.player.nameHistory[0];(t.oldName!==e.name||t.newName!==e.name)&&o.push({type:"player",id:`${e.playerId}-name`,title:`${e.name} (formerly: ${t.oldName})`,subtitle:`Name changed • ${e.allianceTag||"No Alliance"} • ${u(parseInt(e.currentPower))} Power`,power:parseInt(e.currentPower),url:`/dashboard/player/${e.playerId}`,relevance:.8*r})}});let l=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:{snapshotId:n.id,allianceTag:{not:null,contains:t,mode:"insensitive"}},select:{allianceTag:!0,currentPower:!0},distinct:["allianceTag"]}),s=new Map;for(let e of l)if(e.allianceTag){let r=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:{snapshotId:n.id,allianceTag:e.allianceTag},select:{currentPower:!0}}),t=r.length,a=r.reduce((e,r)=>{let t=parseInt(r.currentPower||"0");return e+(isNaN(t)?0:t)},0);s.set(e.allianceTag,{memberCount:t,totalPower:a})}for(let[e,r]of Array.from(s.entries()).sort(([,e],[,r])=>r.totalPower-e.totalPower).slice(0,Math.floor(a/3))){let a=function(e,r){let t=r.toLowerCase(),a=e.toLowerCase();return a===t?100:a.startsWith(t)?80:a.includes(t)?60:40}(e,t);o.push({type:"alliance",id:e,title:e,subtitle:`Alliance • ${r.memberCount} members • ${u(r.totalPower)} total power`,memberCount:r.memberCount,power:r.totalPower,url:`/dashboard/players?alliance=${encodeURIComponent(e)}`,relevance:a})}let c=o.sort((e,r)=>r.relevance-e.relevance).slice(0,a);return i.Z.json({results:c,query:t,totalResults:c.length,snapshotInfo:{id:n.id,timestamp:n.timestamp,kingdom:n.kingdom,filename:n.filename}})}catch(e){return console.error("Error in global search:",e),i.Z.json({error:"Search failed",results:[],query:"",totalResults:0},{status:500})}}function u(e){return e>=1e9?`${(e/1e9).toFixed(1)}B`:e>=1e6?`${(e/1e6).toFixed(1)}M`:e>=1e3?`${(e/1e3).toFixed(1)}K`:e.toLocaleString()}let p=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/search/global/route",pathname:"/api/search/global",filename:"route",bundlePath:"app/api/search/global/route"},resolvedPagePath:"/Users/ciaranobrien/player-tracker/src/app/api/search/global/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:w,headerHooks:y,staticGenerationBailout:f}=p,b="/api/search/global/route";function g(){return(0,l.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:h})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[3499,7386],()=>t(96294));module.exports=a})();