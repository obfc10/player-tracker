"use strict";(()=>{var e={};e.id=6041,e.ids=[6041],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},57002:(e,t,r)=>{r.r(t),r.d(t,{headerHooks:()=>h,originalPathname:()=>x,patchFetch:()=>g,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>b,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>w});var a={};r.r(a),r.d(a,{GET:()=>d,dynamic:()=>c,runtime:()=>u});var o=r(6170),n=r(8533),s=r(54387),i=r(40064),l=r(16395);(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}();let u="nodejs",c="force-dynamic";async function d(e){try{if(!await (0,l.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}())))return i.Z.json({error:"Unauthorized"},{status:401});let{searchParams:t}=new URL(e.url),r=t.get("seasonMode")||"current",a=t.get("seasonId"),o={};if("current"===r||"specific"===r){let e="specific"===r&&a?a:(await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).season.findFirst({where:{isActive:!0}}))?.id;e&&(o.seasonId=e)}let n=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).snapshot.findFirst({where:o,orderBy:{timestamp:"desc"},include:{players:{include:{player:!0}}}});if(!n)return i.Z.json({totalPlayers:0,activeAlliances:0,totalPower:0,lastUpdate:null,recentUploads:0,allianceDistribution:[],topPlayers:[],powerDistribution:[{label:"0-1M",count:0},{label:"1M-10M",count:0},{label:"10M-50M",count:0},{label:"50M-100M",count:0},{label:"100M+",count:0}],snapshotInfo:null});let s=n.players.length,u=new Set(n.players.map(e=>e.allianceTag).filter(e=>e&&""!==e.trim())),c=u.size,d=n.players.reduce((e,t)=>e+parseInt(t.currentPower||"0"),0),p=new Date;p.setDate(p.getDate()-30);let m=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).upload.count({where:{createdAt:{gte:p},status:"COMPLETED"}}),f=Array.from(u).map(e=>{let t=n.players.filter(t=>t.allianceTag===e).length,r=n.players.filter(t=>t.allianceTag===e).reduce((e,t)=>e+parseInt(t.currentPower||"0"),0);return{name:e,memberCount:t,totalPower:r}}).sort((e,t)=>t.totalPower-e.totalPower).slice(0,10),b=n.players.sort((e,t)=>parseInt(t.currentPower||"0")-parseInt(e.currentPower||"0")).slice(0,10).map(e=>({lordId:e.playerId,name:e.name,currentPower:parseInt(e.currentPower||"0"),allianceTag:e.allianceTag})),h=[{label:"0-1M",min:0,max:1e6,count:0},{label:"1M-10M",min:1e6,max:1e7,count:0},{label:"10M-50M",min:1e7,max:5e7,count:0},{label:"50M-100M",min:5e7,max:1e8,count:0},{label:"100M+",min:1e8,max:1/0,count:0}];return n.players.forEach(e=>{let t=parseInt(e.currentPower||"0");for(let e of h)if(t>=e.min&&t<e.max){e.count++;break}}),i.Z.json({totalPlayers:s,activeAlliances:c,totalPower:d,lastUpdate:n.timestamp,recentUploads:m,allianceDistribution:f,topPlayers:b,powerDistribution:h,snapshotInfo:{kingdom:n.kingdom,filename:n.filename,timestamp:n.timestamp}})}catch(e){return console.error("Error fetching dashboard stats:",e),i.Z.json({error:"Failed to fetch dashboard statistics"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/dashboard/stats/route",pathname:"/api/dashboard/stats",filename:"route",bundlePath:"app/api/dashboard/stats/route"},resolvedPagePath:"/Users/ciaranobrien/player-tracker/src/app/api/dashboard/stats/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:f,serverHooks:b,headerHooks:h,staticGenerationBailout:w}=p,x="/api/dashboard/stats/route";function g(){return(0,s.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:f})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[3499,7386,6395],()=>r(57002));module.exports=a})();