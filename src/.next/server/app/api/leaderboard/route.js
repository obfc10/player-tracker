"use strict";(()=>{var e={};e.id=7414,e.ids=[7414],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},8919:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>w,originalPathname:()=>b,patchFetch:()=>I,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>f});var a={};t.r(a),t.d(a,{GET:()=>u,dynamic:()=>d,runtime:()=>c});var n=t(6170),o=t(8533),i=t(54387),s=t(40064),l=t(16395);(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}();let c="nodejs",d="force-dynamic";async function u(e){try{if(!await (0,l.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}())))return s.Z.json({error:"Unauthorized"},{status:401});let{searchParams:r}=new URL(e.url),t=r.get("sortBy")||"currentPower",a="asc"===r.get("order")?"asc":"desc",n=r.get("alliance")||"all",o=parseInt(r.get("limit")||"50"),i=parseInt(r.get("page")||"1"),c=r.get("seasonMode")||"current",d=r.get("seasonId"),u={};if("current"===c||"specific"===c){let e="specific"===c&&d?d:(await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).season.findFirst({where:{isActive:!0}}))?.id;e&&(u.seasonId=e)}let p=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).snapshot.findFirst({where:u,orderBy:{timestamp:"desc"}});if(!p)return s.Z.json({players:[],totalPlayers:0,currentPage:1,totalPages:0,alliances:[]});let m={snapshotId:p.id};"all"!==n&&(m.allianceTag=n);let g=e=>["currentPower","power","merits","unitsKilled","unitsDead","unitsHealed","buildingPower","heroPower","legionPower","techPower","gold","wood","ore","mana","gems"].includes(e),h=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.count({where:m}),w=(await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:m,include:{player:!0}})).sort((e,r)=>{let n,o;if(g(t))n=parseInt(e[t]||"0"),o=parseInt(r[t]||"0");else switch(t){case"name":n=e.name,o=r.name;break;case"cityLevel":case"victories":case"defeats":case"citySieges":case"scouted":case"helpsGiven":case"division":n=e[t]||0,o=r[t]||0;break;default:n=parseInt(e.currentPower||"0"),o=parseInt(r.currentPower||"0")}return"asc"===a?n>o?1:n<o?-1:0:n<o?1:n>o?-1:0}).slice((i-1)*o,i*o),f=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:{snapshotId:p.id,allianceTag:{not:null}},select:{allianceTag:!0},distinct:["allianceTag"],orderBy:{allianceTag:"asc"}}),b=w.map((e,r)=>{let t=parseInt(e.unitsKilled||"0"),a=parseInt(e.unitsDead||"0"),n=e.victories||0,s=e.defeats||0,l=a>0?(t/a).toFixed(2):"N/A",c=n+s>0?(n/(n+s)*100).toFixed(1):"N/A";return parseInt(e.buildingPower||"0"),parseInt(e.heroPower||"0"),parseInt(e.legionPower||"0"),parseInt(e.techPower||"0"),{rank:(i-1)*o+r+1,lordId:e.playerId,name:e.name,currentName:e.player.currentName,hasLeftRealm:e.player.hasLeftRealm,lastSeenAt:e.player.lastSeenAt,leftRealmAt:e.player.leftRealmAt,allianceTag:e.allianceTag,division:e.division,cityLevel:e.cityLevel,faction:e.faction,currentPower:parseInt(e.currentPower||"0"),power:parseInt(e.power||"0"),buildingPower:parseInt(e.buildingPower||"0"),heroPower:parseInt(e.heroPower||"0"),legionPower:parseInt(e.legionPower||"0"),techPower:parseInt(e.techPower||"0"),unitsKilled:t,unitsDead:a,unitsHealed:parseInt(e.unitsHealed||"0"),merits:parseInt(e.merits||"0"),victories:n,defeats:s,citySieges:e.citySieges||0,scouted:e.scouted||0,killDeathRatio:l,winRate:c,totalCombats:n+s,helpsGiven:e.helpsGiven||0,gold:parseInt(e.gold||"0"),wood:parseInt(e.wood||"0"),ore:parseInt(e.ore||"0"),mana:parseInt(e.mana||"0"),gems:parseInt(e.gems||"0"),t1KillCount:parseInt(e.t1KillCount||"0"),t2KillCount:parseInt(e.t2KillCount||"0"),t3KillCount:parseInt(e.t3KillCount||"0"),t4KillCount:parseInt(e.t4KillCount||"0"),t5KillCount:parseInt(e.t5KillCount||"0")}});return s.Z.json({players:b,totalPlayers:h,currentPage:i,totalPages:Math.ceil(h/o),limit:o,sortBy:t,order:a,alliance:n,alliances:f.map(e=>e.allianceTag).filter(Boolean),snapshotInfo:{id:p.id,timestamp:p.timestamp,kingdom:p.kingdom,filename:p.filename}})}catch(e){return console.error("Error fetching leaderboard:",e),s.Z.json({error:"Failed to fetch leaderboard data"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/leaderboard/route",pathname:"/api/leaderboard",filename:"route",bundlePath:"app/api/leaderboard/route"},resolvedPagePath:"/Users/ciaranobrien/player-tracker/src/app/api/leaderboard/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:m,staticGenerationAsyncStorage:g,serverHooks:h,headerHooks:w,staticGenerationBailout:f}=p,b="/api/leaderboard/route";function I(){return(0,i.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:g})}}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[3499,7386,6395],()=>t(8919));module.exports=a})();