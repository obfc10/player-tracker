"use strict";(()=>{var e={};e.id=8440,e.ids=[8440],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},39491:e=>{e.exports=require("assert")},14300:e=>{e.exports=require("buffer")},6113:e=>{e.exports=require("crypto")},82361:e=>{e.exports=require("events")},13685:e=>{e.exports=require("http")},95687:e=>{e.exports=require("https")},63477:e=>{e.exports=require("querystring")},57310:e=>{e.exports=require("url")},73837:e=>{e.exports=require("util")},59796:e=>{e.exports=require("zlib")},41683:(e,t,a)=>{a.r(t),a.d(t,{headerHooks:()=>f,originalPathname:()=>b,patchFetch:()=>w,requestAsyncStorage:()=>m,routeModule:()=>p,serverHooks:()=>g,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>v});var r={};a.r(r),a.d(r,{GET:()=>u,dynamic:()=>d,runtime:()=>c});var o=a(6170),l=a(8533),s=a(54387),i=a(40064),n=a(16395);(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e})(),function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}();let c="nodejs",d="force-dynamic";async function u(e){try{if(!await (0,n.getServerSession)(Object(function(){var e=Error("Cannot find module '@/lib/auth'");throw e.code="MODULE_NOT_FOUND",e}())))return i.Z.json({error:"Unauthorized"},{status:401});let{searchParams:t}=new URL(e.url),a=t.get("sortBy")||"totalPower",r="asc"===t.get("order")?"asc":"desc",o=parseInt(t.get("limit")||"50"),l=t.get("seasonMode")||"current",s=t.get("seasonId"),c={};if("current"===l||"specific"===l){let e="specific"===l&&s?s:(await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).season.findFirst({where:{isActive:!0}}))?.id;e&&(c.seasonId=e)}let d=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).snapshot.findFirst({where:c,orderBy:{timestamp:"desc"}});if(!d)return i.Z.json({alliances:[],snapshotInfo:null});let u=await Object(function(){var e=Error("Cannot find module '@/lib/db'");throw e.code="MODULE_NOT_FOUND",e}()).playerSnapshot.findMany({where:{snapshotId:d.id,allianceTag:{not:null}}}),p=new Map;u.forEach(e=>{let t=e.allianceTag;if(!t)return;p.has(t)||p.set(t,{tag:t,memberCount:0,totalPower:0,averagePower:0,totalKills:0,totalDeaths:0,totalMerits:0,totalVictories:0,totalDefeats:0,totalHelps:0,totalResources:0,averageLevel:0,killDeathRatio:0,winRate:0,topPlayer:{name:"",power:0},members:[]});let a=p.get(t),r=parseInt(e.currentPower||"0"),o=parseInt(e.unitsKilled||"0"),l=parseInt(e.unitsDead||"0"),s=parseInt(e.merits||"0"),i=e.victories||0,n=e.defeats||0,c=e.helpsGiven||0,d=e.cityLevel||0;a.members.push({name:e.name,lordId:e.playerId,power:r,cityLevel:d}),a.memberCount++,a.totalPower+=r,a.totalKills+=o,a.totalDeaths+=l,a.totalMerits+=s,a.totalVictories+=i,a.totalDefeats+=n,a.totalHelps+=c,a.totalResources+=parseInt(e.gold||"0")+parseInt(e.wood||"0")+parseInt(e.ore||"0")+parseInt(e.mana||"0")+parseInt(e.gems||"0"),r>a.topPlayer.power&&(a.topPlayer={name:e.name,power:r,lordId:e.playerId}),a.averageLevel=a.averageLevel+(d-a.averageLevel)/a.memberCount});let m=Array.from(p.values()).map(e=>(e.averagePower=Math.round(e.totalPower/e.memberCount),e.averageLevel=Math.round(e.averageLevel),e.killDeathRatio=e.totalDeaths>0?(e.totalKills/e.totalDeaths).toFixed(2):"N/A",e.winRate=e.totalVictories+e.totalDefeats>0?(e.totalVictories/(e.totalVictories+e.totalDefeats)*100).toFixed(1):"N/A",e));m.sort((e,t)=>{let o,l;switch(a){case"memberCount":o=e.memberCount,l=t.memberCount;break;case"averagePower":o=e.averagePower,l=t.averagePower;break;case"totalKills":o=e.totalKills,l=t.totalKills;break;case"totalMerits":o=e.totalMerits,l=t.totalMerits;break;case"killDeathRatio":o=parseFloat("N/A"===e.killDeathRatio?"0":e.killDeathRatio),l=parseFloat("N/A"===t.killDeathRatio?"0":t.killDeathRatio);break;case"winRate":o=parseFloat("N/A"===e.winRate?"0":e.winRate),l=parseFloat("N/A"===t.winRate?"0":t.winRate);break;case"averageLevel":o=e.averageLevel,l=t.averageLevel;break;case"tag":o=e.tag,l=t.tag;break;default:o=e.totalPower,l=t.totalPower}return"string"==typeof o&&"string"==typeof l?"asc"===r?o.localeCompare(l):l.localeCompare(o):"asc"===r?o-l:l-o});let h=m.slice(0,o).map((e,t)=>({...e,rank:t+1}));return i.Z.json({alliances:h,totalAlliances:m.length,sortBy:a,order:r,snapshotInfo:{id:d.id,timestamp:d.timestamp,kingdom:d.kingdom,filename:d.filename}})}catch(e){return console.error("Error fetching alliance leaderboard:",e),i.Z.json({error:"Failed to fetch alliance leaderboard data"},{status:500})}}let p=new o.AppRouteRouteModule({definition:{kind:l.x.APP_ROUTE,page:"/api/leaderboard/alliances/route",pathname:"/api/leaderboard/alliances",filename:"route",bundlePath:"app/api/leaderboard/alliances/route"},resolvedPagePath:"/Users/ciaranobrien/player-tracker/src/app/api/leaderboard/alliances/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:g,headerHooks:f,staticGenerationBailout:v}=p,b="/api/leaderboard/alliances/route";function w(){return(0,s.patchFetch)({serverHooks:g,staticGenerationAsyncStorage:h})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[3499,7386,6395],()=>a(41683));module.exports=r})();